\documentclass{scrartcl}

\deffootnote{1em}{1em}{\textsuperscript{\thefootnotemark}}

\addtokomafont{disposition}{\rmfamily}
\addtokomafont{descriptionlabel}{\rmfamily}

\RequirePackage
    [bitstream-charter,greekuppercase=italicized]
    {mathdesign}
\renewcommand{\sfdefault}{fvs}
\renewcommand{\ttdefault}{fvm}

\usepackage[utf8x]{inputenc}

\SetUnicodeOption{mathletters}

\PreloadUnicodePage{3}

\usepackage{microtype}

\usepackage[hidelinks]{hyperref}

\usepackage{amsmath}

\newenvironment{mathfigure}[2]
    {%
        \begin{figure}
        \newcommand{\figurelabel}{#1}
        \newcommand{\figurecaption}{#2}
        \centering
        \begin{math}
    }
    {
        \end{math}
        \caption{\figurecaption}
        \label{\figurelabel}
        \end{figure}%
    }

\newcommand{\bnfdef}{\mathrel{{\mathop:}{\mathop:}{=}}}

\newcommand{\optional}{^?}
\newcommand{\some}{^+}
\newcommand{\many}{^*}

\newcommand{\newkw}[1]
           {\expandafter\newcommand\csname kw#1\endcsname{\mathbf{#1}}}

\newkw{let}
\newkw{in}
\newkw{if}
\newkw{then}
\newkw{else}
\newkw{left}
\newkw{right}
\newkw{trace}

\newkw{env}
\newkw{withenv}
\newkw{gate}
\newkw{defer}
\newkw{abort}

\newcommand{\exlet}[2]{\kwlet \; #1 \; \kwin \; #2}
\newcommand{\exif}[3]{\kwif \; #1 \; \kwthen \; #2 \; \kwelse \; #3}
\newcommand{\exlam}[2]{\backslash \; #1 → #2}
\newcommand{\exclam}[2]{\# \; #1 → #2}
\newcommand{\exapp}[2]{#1 \; #2}
\newcommand{\exleft}[1]{\kwleft \; #1}
\newcommand{\exright}[1]{\kwright \; #1}
\newcommand{\extrace}[1]{\kwtrace \; #1}

\newcommand{\exwithenv}[1]{\kwwithenv \; #1}
\newcommand{\exgate}[1]{\kwgate \; #1}
\newcommand{\exdefer}[1]{\kwdefer \; #1}
\newcommand{\exabort}[1]{\kwabort \; #1}

\newcommand{\newnt}[1]
           {\expandafter\newcommand\csname#1\endcsname{\mathit{#1}}}

\newnt{Char}
\newnt{Letter}
\newnt{Digit}

\newnt{Token}
\newnt{Ident}
\newnt{Str}
\newnt{Nat}
\newnt{Keyword}
\newnt{Symbol}

\newnt{Prog}
\newnt{Assign}
\newnt{Expr}
\newnt{Let}
\newnt{If}
\newnt{Lam}
\newnt{CLam}
\newnt{App}
\newnt{List}
\newnt{TNat}
\newnt{FNat}
\newnt{Pair}
\newnt{Left}
\newnt{Right}
\newnt{Trace}
\newnt{Var}

\newnt{Zero}
\newnt{Env}
\newnt{WithEnv}
\newnt{Gate}
\newnt{Defer}
\newnt{Abort}

\newcommand{\internal}{_\mathrm{i}}

\newcommand{\suc}[1]{\hat{n}}

\title{Specification of the Stand-in Language}
\author{%
    Wolfgang Jeltsch\\
    \small Well-Typed LLP\\
    \small\texttt{wolfgang@well-typed.com}%
}

\begin{document}

\maketitle

\section{Syntax}

We distinguish between the surface language, which is the actual
Stand-in Language, and the internal language, which we use for defining
evaluation. In Section~\ref{desugaring}, we define the translation from
the surface to the internal language.

We describe all syntax using a variant of Backus–Naur form. Our variant
uses the following notations, listed here in increasing order of
precedence:
\begin{itemize}

\item

Words in italics are nonterminals.

\item

$∣$ denotes set union.

\item

$∖$ denotes set difference.

\item

Mere juxtaposition denotes concatenation.

\item

$\optional$, $\some$, and $\many$ denote optionality, repetition with at
least one occurrence, and arbitrary repetition, respectively.

\item

$⟨$~and~$⟩$ delimit subexpressions and are used for overriding default
precedence.\footnote{We do not use $($ and~$)$ for this purpose, since
they are part of the language we want to describe.}

\end{itemize}

\subsection{Surface Language}

Figure~\ref{token-syntax-of-the-surface-language} defines the syntax of
tokens. Based on that, Figure~\ref{syntax-of-the-surface-language}
defines the syntax of the language. The nonterminals $\CLam$, $\TNat$,
and $\FNat$ stand for “complete lambda”, “tuple natural”, and “function
natural”, respectively.
\begin{mathfigure}{token-syntax-of-the-surface-language}
                  {Token syntax of the surface language}
%
\begin{aligned}
%
\Token   & \bnfdef \Ident ∣ \Str ∣ \Nat ∣ \Keyword ∣ \Symbol    \\
\Ident   & \bnfdef \Letter⟨\Letter ∣ \Digit ∣ \_ ∣ {′}⟩\many ∖
                   \Keyword                                     \\
\Str     & \bnfdef \text{“}\Char\many\text{”}                   \\
\Nat     & \bnfdef \Digit\some                                  \\
\Keyword & \bnfdef \kwlet ∣ \kwin ∣ \kwif ∣ \kwthen ∣ \kwelse ∣
                   \kwleft ∣ \kwright ∣ \kwtrace                \\
\Symbol  & \bnfdef {=} ∣ {:} ∣ {[} ∣ {]} ∣ {\{} ∣ {\}} ∣ {,} ∣
                   \backslash ∣ \# ∣ {→} ∣ \$ ∣ {(} ∣ {)}
%
\end{aligned}
%
\end{mathfigure}
\begin{mathfigure}{syntax-of-the-surface-language}
                  {Syntax of the surface language}
%
\begin{aligned}
%
\Prog   & \bnfdef \Assign\some                                   \\
\Assign & \bnfdef \Ident \; ⟨{:} \; \Expr₀⟩\optional = \Expr₀    \\
\Expr₀  & \bnfdef \Let ∣ \If ∣ \Lam ∣ \CLam ∣ \Expr₁             \\
\Let    & \bnfdef \exlet{\Assign\many}{\Expr₀}                   \\
\If     & \bnfdef \exif{\Expr₀}{\Expr₀}{\Expr₀}                  \\
\Lam    & \bnfdef \exlam{\Var\some}{\Expr₀}                      \\
\CLam   & \bnfdef \exclam{\Var\some}{\Expr₀}                     \\
\Expr₁  & \bnfdef \App ∣ \Expr₂                                  \\
\App    & \bnfdef \exapp{\Expr₁}{\Expr₂}                         \\
\Expr₂  & \bnfdef \List ∣ \Str ∣ \TNat ∣ \FNat ∣ \Pair ∣ \Left ∣
                  \Right ∣ \Trace ∣ \Var ∣ (\Expr₀)              \\
\List   & \bnfdef [] ∣ [\Expr₀ ⟨, \Expr₀⟩\many]                  \\
\TNat   & \bnfdef \Nat                                           \\
\FNat   & \bnfdef \$\Nat                                         \\
\Pair   & \bnfdef \{\Expr₀, \Expr₀\}                             \\
\Left   & \bnfdef \exleft{\Expr₂}                                \\
\Right  & \bnfdef \exright{\Expr₂}                               \\
\Trace  & \bnfdef \extrace{\Expr₂}                               \\
\Var    & \bnfdef \Ident                                         \\
%
\end{aligned}
%
\end{mathfigure}
%NOTE: The vertical bars in the grammar source are not the ASCII
%      character U+007C VERTICAL LINE but the character U+2223 DIVIDES,
%      which the ucs package translates into \mid. This is important to
%      get the proper spacing.

\subsection{Internal Language}

Figure~\ref{token-syntax-of-the-internal-language} defines the syntax of
tokens. Based on that, Figure~\ref{syntax-of-the-internal-language}
defines the syntax of the language.
\begin{mathfigure}{token-syntax-of-the-internal-language}
                  {Token syntax of the internal language}
%
\begin{aligned}
%
\Token\internal   & \bnfdef \Keyword\internal ∣ \Symbol\internal     \\
\Keyword\internal & \bnfdef \kwleft ∣ \kwright ∣ \kwenv ∣ \kwwithenv
                            ∣ \kwgate ∣ \kwdefer ∣ \kwabort ∣
                            \kwtrace                                 \\
\Symbol\internal  & \bnfdef ∅ ∣ {\{} ∣ {\}} ∣ {,} ∣ {(} ∣ {)}
%
\end{aligned}
%
\end{mathfigure}
\begin{mathfigure}{syntax-of-the-internal-language}
                  {Syntax of the internal language}
%
\begin{aligned}
%
\Prog\internal  & \bnfdef \Expr\internal                              \\
\Expr\internal  & \bnfdef \Zero ∣ \Pair\internal ∣ \Left\internal ∣
                          \Right\internal ∣ \Env ∣ \WithEnv ∣ \Gate ∣
                          \Defer ∣ \Abort ∣ \Trace\internal ∣
                          (\Expr\internal)                            \\
\Zero           & \bnfdef ∅                                           \\
\Pair\internal  & \bnfdef \{\Expr\internal, \Expr\internal\}          \\
\Left\internal  & \bnfdef \exleft{\Expr\internal}                     \\
\Right\internal & \bnfdef \exright{\Expr\internal}                    \\
\Env            & \bnfdef \kwenv                                      \\
\WithEnv        & \bnfdef \exwithenv{\Expr\internal}                  \\
\Gate           & \bnfdef \exgate{\Expr\internal}                     \\
\Defer          & \bnfdef \exdefer{\Expr\internal}                    \\
\Abort          & \bnfdef \exabort{\Expr\internal}                    \\
\Trace\internal & \bnfdef \extrace{\Expr\internal}
%
\end{aligned}
%
\end{mathfigure}

\section{Desugaring}
\label{desugaring}

For defining desugaring, we introduce the following special meta-syntax:
\begin{itemize}

\item

$⟨e⟩_{x ↦ e′}$ means the expression~$e$ with free occurrences of~$x$
replaced by~$e′$.

\item

$c_\#$ means the natural number literal that represents the code of the
character~$c$.

\item

$\suc{n}$ means the natural number literal that represents the successor
of~$n$.

\item

$f^n x$ means the n-fold application of~$f$ to~$x$, that is,
$\exapp{f}{\exapp{…}{\exapp{f}{\exapp{x}}}}$ where $f$ occurs $n$~times.

\end{itemize}
Furthermore we introduce a helper function~$ρ : \Var\some × \Var →
\Expr\internal$. A term $ρ(Γ, x)$ yields an internal expression that is
evaluated to a pair whose first element is the value of~$x$. The
argument~$Γ$ is called a context. A context is a list of variables that
are in scope, with variables bound closer to the expression being listed
later. We write $Γ ⊳ x$ for the context~$Γ$ extended by~$x$. The
definition of~$ρ$ is as follows:
\begin{equation}
%
ρ(Γ ⊳ x, y) = \begin{cases}
                  \kwenv            & \text{if $x = y$} \\
                  \exright{ρ(Γ, y)} & \text{if $x ≠ y$}
              \end{cases}
%
\end{equation}

Figure~\ref{desugaring-of-expressions} defines a function $⌊−⌋_− : \Expr
× \Var\many → \Expr\internal$ that describes desugaring of expressions.
A term $⌊e⌋_Γ$ gives the internal expression that corresponds to the
surface expression~$e$ under the context~$Γ$. Based on $⌊−⌋_−$ we define
a function $⌊−⌋ : \Prog → \Prog\internal$ that describes desugaring of
programs:
\begin{equation}
%
⌊p⌋ = ⌊\exlet{p}{\mathit{main}}⌋_ε
%
\end{equation}
\begin{mathfigure}{desugaring-of-expressions}{Desugaring of expressions}
%
\newcommand{\nextline}{\\ & \mathrel{\phantom{=}}}
\newcommand{\exapprhs}{
    \kwwithenv
    \nextline
    \quad \kwwithenv \; \{
    \nextline
    \quad\quad \exdefer{
                   \{
                       \exleft{\exright{\kwenv}},
                       \{\exleft{\kwenv}, \exright{\exright{\kwenv}}\}
                   \}
               },
    \nextline
    \quad\quad \{⌊e₂⌋_Γ, ⌊e₁⌋_Γ\}
    \nextline
    \quad \}
}
%
\begin{aligned}
%
⌊\kwlet \; \kwin \; e⌋_Γ         & = ⌊e⌋_Γ                            \\
⌊\exlet{x = e′ \; \bar{a}}{e}⌋_Γ & = ⌊
                                         ⟨\exlet{\bar{a}}{e}⟩
                                             _{x ↦ e′}
                                     ⌋_Γ \\
⌊\exif{e}{e₁}{e₂}⌋_Γ             & = \exwithenv{
                                         \{
                                             \exgate{⌊e⌋_Γ},
                                             \{⌊e₁⌋_Γ, ⌊e₂⌋_Γ\}
                                         \}
                                     }                                \\
⌊\exlam{\bar{x}}{e}⌋_Γ           & = \{
                                         \exdefer{⌊e⌋_{Γ ∘ \bar{x}}},
                                         \kwenv
                                     \}                               \\
⌊\exclam{\bar{x}}{e}⌋_Γ          & = \{
                                         \exdefer{⌊e⌋_{\bar{x}}},
                                         ∅
                                     \}                               \\
⌊\exapp{e₁}{e₂}⌋_Γ               & = \exapprhs                        \\
⌊[]⌋_Γ                           & = ∅                                \\
⌊[e, l]⌋_Γ                       & = \{⌊e⌋_Γ, ⌊[l]⌋_Γ\}               \\
⌊\text{“}\,\text{”}⌋_Γ           & = ∅                                \\
⌊\text{“}c\bar{c}\text{”}⌋_Γ     & = \{
                                         ⌊c_\#⌋_Γ,
                                         ⌊\text{“}\bar{c}\text{”}⌋_Γ
                                     \}  \\
⌊0⌋_Γ                            & = ∅                                \\
⌊\suc{n}⌋_Γ                      & = \{⌊n⌋_Γ, ∅\}                     \\
⌊\${n}⌋_Γ                        & = ⌊\exclam{f \; x}{f^n x}⌋_Γ       \\
⌊\{e₁, e₂\}⌋_Γ                   & = \{⌊e₁⌋_Γ, ⌊e₂⌋_Γ\}               \\
⌊\exleft{e}⌋_Γ                   & = \exleft{⌊e⌋_Γ}                   \\
⌊\exright{e}⌋_Γ                  & = \exright{⌊e⌋_Γ}                  \\
⌊\extrace{e}⌋_Γ                  & = \extrace{⌊e⌋_Γ}                  \\
⌊x⌋_Γ                            & = \exleft{ρ(Γ, x)}                 \\
⌊(e)⌋_Γ                          & = ⌊e⌋_Γ
%
\end{aligned}
%
\end{mathfigure}

\end{document}
